<!--
  #%L
  Bitrepository Webclient
  %%
  Copyright (C) 2010 - 2013 The State and University Library, The Royal Library and The State Archives, Denmark
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as 
  published by the Free Software Foundation, either version 2.1 of the 
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public 
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-2.1.html>.
  #L%
  -->
<!DOCTYPE html>
<html lang="UTF-8">
<head>
  <title>Bitrepository integrity service</title>
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/integrity-service.css" rel="stylesheet" type="text/css">
  <link href="css/modal.css" rel="stylesheet" type="text/css">
</head>
<body>

<div id="pageMenu"></div>
<div class="container-fluid">
  <div class="row-fluid" style="margin-left:-20px">
    <div class="span11" style="height:0; min-height:0"></div>
    <div class="span11">
      <h2>Integrity service</h2>
      <legend>
        <span>
          <span id="integrityLegend">
            Integrity information
          </span>
          <span class="pull-right">
            Change collection: <select class="input" id="collectionChooser"></select>
          </span>
        </span>
      </legend>
    </div>
    <div class="span11" id="collectionInfoDiv"></div>
    <div class="span11">
      <legend>Workflows status</legend>
      <table class="table table-bordered">
        <thead>
        <tr>
          <th>Workflow name</th>
          <th>Next run</th>
          <th>Last run</th>
          <th>Interval</th>
          <th>Current state</th>
        </tr>
        </thead>
        <tbody id="workflow-status-table-body"></tbody>
      </table>
    </div>
    <div class="span11">
      <form class="form-inline">
        <select id="workflowSelector"></select>
        <button type="submit" class="btn" id="workflowStarter">Start</button>
        <div id="formStatus"></div>
      </form>
    </div>
    <div class="span11">
      <legend>
        <span>
          <span>Integrity status</span>
          <span class="pull-right" id="integrityReportGetter"></span>
        </span>
      </legend>
      <table id="integrity-status-table" class="table table-bordered table-striped">
        <thead>
        <tr style="text-align: center">
          <th>Pillar ID</th>
          <th>Pillar Name</th>
          <th>Pillar Type</th>
          <th>Total number of files</th>
          <th id="all-missingFiles">Number of missing files</th>
          <th id="all-missingChecksums">Number of missing checksums</th>
          <th id="all-obsoleteChecksums">Number of obsolete checksums</th>
          <th id="all-checksumErrors">Number of inconsistent checksums</th>
        </tr>
        </thead>
        <tbody id="integrity-status-table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modalDialog" class="modal-dialog hide fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-header" style="text-align: center">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3 id="modalLabel">Modal header</h3>
  </div>
  <div class="modal-body" id="modalBody">
    <p>Loading</p>
  </div>
</div>

<script src="jquery/jquery-1.9.0.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="menu.js"></script>
<script src="table-modal.js"></script>
<script src="download-modal.js"></script>
<script src="utils.js"></script>
<script src="CollectionNameMapper.js"></script>
<script src="numeral.min.js"></script>

<script>
    let pillarIntegrityStatuses = {};
    let workflows = {};
    let modal;
    let downloadModal;
    let updatePageInterval;
    let nameMapper;
    let integrityServiceUrl;

    function formatInt(number) {
        return numeral(number).format('0,0');
    }

    function loadWorkflows() {
        let url = integrityServiceUrl + '/integrity/IntegrityService/getWorkflowList/?collectionID=' + getCollectionID();
        $.getJSON(url, {}, function (json) {
            for (let i = 0; i < json.length; i++) {
                $("#workflowSelector").append('<option value="' + json[i] + '">' + json[i] + '</option>');
            }
        });
    }

    function makeWorkflowRow(workflowID, nextRun, lastRun, executionInterval, currentState, lastRunState) {
        let html = "";
        html += "<tr><td><a class=\"btn btn-link\" id=\"" + workflowID + "-details\">" + workflowID + "</a></td>";
        html += "<td><div id=\"" + workflowID + "-nextRun\" style=\"padding:5px\">" + nextRun + "</div></td>";
        html += "<td><a class=\"btn btn-link\" id=\"" + workflowID + "-lastRun\">" + lastRun
            + "</a> <span id=\"" + workflowID + "-lastRunState\">(" + lastRunState + ")</span></td>";
        html += "<td><div id=\"" + workflowID + "-executionInterval\" style=\"padding:5px\">" + executionInterval + "</div></td>";
        html += "<td><div id=\"" + workflowID + "-currentState\" style=\"padding:5px\">" + currentState + "</div></td></tr>";
        return html;
    }

    function updateWorkflowRow(workflowID, nextRun, lastRun, executionInterval, currentState, lastRunState) {
        $("#" + workflowID + "-nextRun").html(nextRun);
        $("#" + workflowID + "-lastRun").html(lastRun);
        $("#" + workflowID + "-lastRunState").html("(" + lastRunState + ")");
        $("#" + workflowID + "-executionInterval").html(executionInterval);
        $("#" + workflowID + "-currentState").html(currentState);
    }

    function attachWorkflowInfoButton(id, type) {
        let element;
        let title;
        if (type === "workflowDescription") {
            element = "#" + id + "-details";
            title = "Workflow description";
        } else if (type === "lastRunDetails") {
            element = "#" + id + "-lastRun";
            title = "Last run details";
        }
        if (element != null) {
            $(element).popover({
                placement: "right",
                title: title,
                html: true,
                content: getStoredWorkflowInfo(id, type)
            });
        }
    }

    function getStoredWorkflowInfo(id, type) {
        return function () {
            return nl2br(workflows[id][type]);
        }
    }

    function getWorkflowStatuses() {
        let url = integrityServiceUrl + '/integrity/IntegrityService/getWorkflowSetup?collectionID=' + getCollectionID();
        $.getJSON(url, {}, function (json) {
            for (let i = 0; i < json.length; i++) {
                if (workflows[json[i].workflowID] == null) {
                    $("#workflow-status-table-body").append(
                        makeWorkflowRow(json[i].workflowID, json[i].nextRun, json[i].lastRun, json[i].executionInterval,
                            json[i].currentState, json[i].lastRunFinishState));
                    workflows[json[i].workflowID] = {
                        workflowDescription: json[i].workflowDescription,
                        lastRunDetails: json[i].lastRunDetails
                    };
                    attachWorkflowInfoButton(json[i].workflowID, "workflowDescription");
                    attachWorkflowInfoButton(json[i].workflowID, "lastRunDetails");
                } else {
                    updateWorkflowRow(json[i].workflowID, json[i].nextRun, json[i].lastRun, json[i].executionInterval,
                        json[i].currentState, json[i].lastRunFinishState);
                    workflows[json[i].workflowID].workflowDescription = json[i].workflowDescription;
                    workflows[json[i].workflowID].lastRunDetails = json[i].lastRunDetails;
                }
            }
        });
    }

    function startWorkflow() {
        let ID = $("#workflowSelector option:selected").val();
        let url = integrityServiceUrl + '/integrity/IntegrityService/startWorkflow';
        $('#formStatus').load(url, {
            workflowID: ID,
            collectionID: getCollectionID()
        }).show().fadeOut({duration: 5000});
    }

    /**
     * Callback method to get the value of a specific property from a pillars integrity status.
     * The callback is intended for use by {@see TableModal}.
     *
     * NOTE: The reason for returning a callback instead of the property directly is because of the modal's nature of
     * paging using the integrity status API. As results from the API can change from one call to the next this ensures
     * that the modal page-count properly reflects the underlying state instead of just showing a once-passed static
     * value.
     */
    function getIntegrityStatusPropertyCountCallback(pillarID, propertyName) {
        return function () {
            return pillarIntegrityStatuses[pillarID][propertyName];
        }
    }

    function showModal(type, propertyName, title, url, pillarID) {
        return function () {
            modal = new TableModal(type, pillarID, url, "#modalBody", getIntegrityStatusPropertyCountCallback(pillarID, propertyName), 100);
            $("#modalLabel").html(title);
            $("#modalBody").html("<p>Loading</p>");
            modal.getModal(1);
            $("#modalDialog").modal('show');
        }
    }

    function showDownloadModal(integrityURL) {
        return function () {
            downloadModal = new DownloadModal(getCollectionID(), "#modalBody", integrityURL);
            $("#modalLabel").html("Select Reports to Download");
            $("#modalBody").html("<p>Loading</p>");
            downloadModal.getModal();
            $("#modalDialog").modal('show');
        }
    }

    function getBodyContext(id, type) {
        let context = {};
        context.url = integrityServiceUrl + "/integrity/IntegrityService/";

        if (type === "Pillar Name") {
            context.element = id + "-pillarName";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "pillarName";
        } else if (type === "Pillar Type") {
            context.element = id + "-pillarType";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "pillarType";
        } else if (type === "Total files") {
            context.element = id + "-totalFileCount";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "totalFileCount";
            context.url += "getTotalFileIDs";
        } else if (type === "Missing files") {
            context.element = id + "-missingFiles";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "missingFilesCount";
            context.url += "getAllMissingFileIDs";
        } else if (type === "Missing checksums") {
            context.element = id + "-missingChecksums";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "missingChecksumsCount";
            context.url += "getMissingChecksumsFileIDs";
        } else if (type === "Obsolete checksums") {
            context.element = id + "-obsoleteChecksums";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "obsoleteChecksumsCount";
            context.url += "getObsoleteChecksumsFileIDs";
        } else if (type === "Inconsistent checksums") {
            context.element = id + "-checksumErrors";
            context.title = type + " on " + id.toUpperCase();
            context.propertyName = "checksumErrorCount";
            context.url += "getChecksumErrorFileIDs";
        }
        context.url += "?pillarID=" + id + "&collectionID=" + getCollectionID();
        return context;
    }

    function getHeaderContext(type) {
        let context = {};
        if (type === "Number of missing files") {
            context.element = "all-missingFiles";
            context.title = type + " on all pillars";
        } else if (type === "Number of missing checksums") {
            context.element = "all-missingChecksums";
            context.title = type + " on all pillars";
        } else if (type === "Number of obsolete checksums") {
            context.element = "all-obsoleteChecksums";
            context.title = type + " on all pillars";
        } else if (type === "Number of inconsistent checksums") {
            context.element = "all-checksumErrors";
            context.title = type + " on all pillars";
        }
        return context;
    }

    function makePillarRow(id) {
        let html = "";
        html += "<tr id=\"" + id + "-row\">";
        html += "<td><p class='pillar-info' '>" + id + "</p></td>";
        html += "<td id=\"" + id + "-pillarName\"></td>";
        html += "<td id=\"" + id + "-pillarType\"></td>";
        html += "<td id=\"" + id + "-totalFileCount\"></td>";
        html += "<td id=\"" + id + "-missingFiles\"></td>";
        html += "<td id=\"" + id + "-missingChecksums\"></td>";
        html += "<td id=\"" + id + "-obsoleteChecksums\"></td>";
        html += "<td id=\"" + id + "-checksumErrors\"></td></tr>";
        return html;
    }

    function updateTableHeader() {
        setHeader("Number of missing files");
        setHeader("Number of missing checksums");
        setHeader("Number of obsolete checksums");
        setHeader("Number of inconsistent checksums");
    }

    function setHeader(type) {
        let context = getHeaderContext(type);
        let html = `${type}`;
        $("#" + context.element).html(html);
    }

    function updateTableBody(pillarID) {
        updateStringCell(pillarID, "Pillar Name", pillarIntegrityStatuses[pillarID].pillarName);
        updateStringCell(pillarID, "Pillar Type", pillarIntegrityStatuses[pillarID].pillarType);
        updateIntCell(pillarID, "Total files", pillarIntegrityStatuses[pillarID].totalFileCount);
        updateIntCell(pillarID, "Missing files", pillarIntegrityStatuses[pillarID].missingFilesCount);
        updateIntCell(pillarID, "Missing checksums", pillarIntegrityStatuses[pillarID].missingChecksumsCount);
        updateIntCell(pillarID, "Obsolete checksums", pillarIntegrityStatuses[pillarID].obsoleteChecksumsCount);
        updateIntCell(pillarID, "Inconsistent checksums", pillarIntegrityStatuses[pillarID].checksumErrorCount);
    }

    function updateStringCell(id, type, cellValue) {
        let context = getBodyContext(id, type);
        let html = "<p class='pillar-info'>" + cellValue + "</p>";
        $("#" + context.element).html(html);
    }

    function updateIntCell(pillarID, type, cellValue) {
        let context = getBodyContext(pillarID, type);

        if (cellValue === 0) {
            let html = `<button class="btn btn-link" disabled>${formatInt(cellValue)}</button>`;
            $("#" + context.element).html(html);
        } else {
            let innerElement = context.element + "-a";
            let html = `<a class="btn btn-link" id="${innerElement}">${formatInt(cellValue)}</a>`;
            $("#" + context.element).html(html);
            $("#" + innerElement).click(showModal(type, context.propertyName, context.title, context.url, pillarID));
        }
    }

    function initializePage() {
        $.get('repo/urlservice/integrityService/', {}, function (url) {
            integrityServiceUrl = url;
        }, 'html').done(function () {
            $.getJSON('repo/reposervice/getCollections/', {}, function (collections) {
                nameMapper = new CollectionNameMapper(collections);
                let cols = nameMapper.getCollectionIDs();
                for (let i in cols) {
                    $("#collectionChooser").append(
                        `<option value="${cols[i]}">${nameMapper.getName(cols[i])}</option>`);
                }
                let collectionID = new URLSearchParams(window.location.search).get("collectionID");
                if (collectionID !== null && cols.includes(collectionID)) {
                    setCollection(collectionID);
                } else {
                    collectionChanged(getCollectionID());
                }
            });
        });
    }

    function collectionChanged(collectionID) {
        clearContent();
        $("#integrityLegend").html("Integrity information for collection " + nameMapper.getName(collectionID));

        let reportUrl = `${integrityServiceUrl}/integrity/IntegrityService`;
        $("#integrityReportGetter").html(`<a class="btn btn-link" target="_blank">Download latest integrity reports</a>`).on("click",
            showDownloadModal(reportUrl));

        clearInterval(updatePageInterval);
        loadWorkflows();
        getCollectionInformation(collectionID);
        getWorkflowStatuses();
        getIntegrityStatus();
        updatePageInterval = setInterval(function () {
            getWorkflowStatuses();
            getIntegrityStatus();
            getCollectionInformation(collectionID);
        }, 2500);
    }

    function setCollection(collectionID) {
        $("#collectionChooser").val(collectionID).change();
    }

    function getIntegrityStatus() {
        let url = integrityServiceUrl + "/integrity/IntegrityService/getIntegrityStatus?collectionID="
            + getCollectionID();
        $.getJSON(url, {}, function (json) {
            for (let i = 0; i < json.length; i++) {
                if (pillarIntegrityStatuses[json[i].pillarID] == null) {
                    let tableBody = $("#integrity-status-table-body");
                    tableBody.append(makePillarRow(json[i].pillarID));
                }
                pillarIntegrityStatuses[json[i].pillarID] = {
                    pillarName: json[i].pillarName,
                    pillarType: json[i].pillarType,
                    totalFileCount: json[i].totalFileCount,
                    missingFilesCount: json[i].missingFilesCount,
                    missingChecksumsCount: json[i].missingChecksumsCount,
                    obsoleteChecksumsCount: json[i].obsoleteChecksumsCount,
                    checksumErrorCount: json[i].checksumErrorCount
                };
                updateTableBody(json[i].pillarID);
                updateTableHeader();
            }
        });
    }

    function getCollectionID() {
        return $("#collectionChooser").val();
    }

    function getCollectionInformation() {
        let url = integrityServiceUrl + "/integrity/IntegrityService/getCollectionInformation?collectionID=" + getCollectionID();
        $.getJSON(url, {}, function (json) {
            let infoHtml = `<span><b>Latest ingest: ${json.lastIngest} &nbsp; &nbsp;
                Size: ${json.collectionSize} &nbsp; &nbsp;
                Number of files: ${formatInt(json.numberOfFiles)}</b></span>`;

            $("#collectionInfoDiv").html(infoHtml);
        });

    }

    function clearContent() {
        $("#integrity-status-table-body").empty();
        $("#workflow-status-table-body").empty();
        $("#workflowSelector").empty();
        $("#collectionInfoDiv").empty();
        $("#integrityReportGetter").empty();
        pillarIntegrityStatuses = {};
        workflows = {};
    }

    $(document).ready(function () {
        // Load page content
        makeMenu("integrity-service.html", "#pageMenu");
        initializePage();

        // Setup event / click handling
        $("#workflowStarter").click(function (event) {
            event.preventDefault();
            startWorkflow();
        });
        $("#collectionChooser").change(function (event) {
            event.preventDefault();
            collectionChanged(getCollectionID());
        });

        closePopoverOnClick();
    });
</script>
</body>
</html>